<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" /> 
<meta name="format-detection" content="telephone=no">
<meta name="viewport" content="width=device-width,user-scalable=no,maximum-scale=1.0" />
<title>公益树</title>
<link rel="stylesheet" href="css/style.css" />
<script src="js/jquery-1.9.1.min.js"></script>
<script src="js/main.js"></script>
<script src="https://dev-wap.myrunners.com/Public/Common/js/framework.js"></script>
<script>
	var da;
	var lv;
	shanpao.rem(640);
	shanpao.use(['interface','dataformat','pageelement','wx','bridge'],function(){
		getUserTreeInfo();
	
	});
	function ck(e){
		$(".t_t>img").attr("src","img/wsz.png");
		$(e).attr("src","img/yxz.png");
		da=$(e).attr("id");
	}
	var str;
	// 礼包数
	var lbarr;
	//获取用户公益树相关信息
	function getUserTreeInfo(){                                                                                                                                                                          
		//app.alert('入口');
		var _data={};
		//设定接口名（修改）
        _data.cmd = 'welfareForest';
        _data.opt = 'getUserTreeInfo';     
        //构建接口参数（修改）
        _data.user_id = shanpao.dataformat.gethash().user_id;
        //_data.data.user_token = 'asdfasd'; //这个参数可以注释
        //_data.item_id = 6;
        //_data.donated_value  = 6;     
        _data = JSON.stringify(_data);
        var _prm={};
        _prm.APIDATA = _data;
        console.log('主信息接口上传参数');
        console.log(_prm);
        console.log(_data);
        //发起请求
        shanpao.pageelement.loading();//打开loadi
        var url = shanpao.config.host + shanpao.config.welfare
		shanpao.interface.getData(url,_prm,function(res){						
			console.log(res);
			shanpao.pageelement.loading(0);//关闭loading			
			if(res.result==10000){	
			$(".shubg").attr("src",res.data.logo_url);	
				// 获取经验
				lv=res.data.level;
				str='<p class="lvnum">'+res.data.level_desc+'</p>'
				+'<div class="progressbar"><p class="pb"></p><p class="pbnum">'+res.data.tree_experience+'/'+res.data.level_expe_high+'</p></div>'
				$(".level").append(str)
				$(".pb").css("width",(res.data.tree_experience/res.data.level_expe_high)*100+"%");
				// 获取装饰

				for (var i = 0; i <res.data.decoration_list.length; i++) {
					var item = res.data.decoration_list[i];
						
					str='<img src="'+res.data.decoration_list[i].mini_logo_url+'" alt="" class="z'+(i+1)+'">'
					$(".ornament").append(str);
				};
				// 用户已捐里程 
				$("#donated_mileage").text(res.data.avail_exchange_mileage/1000+"KM")
				$("#donated_mileage1").text(res.data.avail_exchange_mileage/1000+"KM")
				// 可浇水次数
				$("#watering_num").text("x"+res.data.watering_num)
				// 浇水道具所需里程
				$("#watering_mile").text(res.data.watering_mile/1000+"KM兑换");
				// 可施肥次数
				$("#fertilize_num").text("x"+res.data.fertilize_num)
				// 施肥道具所需里程
				$("#fertilize_mile").text(res.data.fertilize_mile/1000+"KM兑换");
				// 可除虫次数
				$("#worm_num").text("x"+res.data.worm_num)
				// 除虫道具所需里程
				$("#worm_mile").text(res.data.worm_mile/1000+"KM兑换");
				if (res.data.package_list.length>0) {
					$(".dian").css("display","block");
					lbarr=res.data.package_list;

				}
				else{$(".dian").css("display","none");lbarr=res.data.package_list;}

			}else{
				shanpao.pageelement.alert(res.result_err_msg);
			}
		});
	}
	//兑换浇水、施肥、除虫
	function exchangeDonatedMileage(e){
		$("#jzlc").css("display","none");
		//app.alert('入口');
		var _data={};
		//设定接口名（修改）
        _data.cmd = 'welfareForest';
        _data.opt = 'exchangeDonatedMileage';     
        //构建接口参数（修改）
        _data.user_id = shanpao.dataformat.gethash().user_id;
        //_data.data.user_token = 'asdfasd'; //这个参数可以注释
        if (e=="watering_mile") {_data.type=1}
        if (e=="fertilize_mile") {_data.type=3}
        if (e=="worm_mile") {_data.type=2}
         _data.exchange_num = jnum;
        //_data.item_id = 6;
        //_data.donated_value  = 6;     
        _data = JSON.stringify(_data);
        var _prm={};
        _prm.APIDATA = _data;
        console.log('主信息接口上传参数');
        console.log(_prm);
        console.log(_data);
        //发起请求
        shanpao.pageelement.loading();//打开loadi
        var url = shanpao.config.host + shanpao.config.welfare
		shanpao.interface.getData(url,_prm,function(res){						
			console.log(res);
			shanpao.pageelement.loading(0);//关闭loading			
			if(res.result==10000){			
				if (res.data.exchange_type==1) {$("#watering_num").text("x"+res.data.tools_num);};
				if (res.data.exchange_type==2) {$("#fertilize_num").text("x"+res.data.tools_num)};
				if (res.data.exchange_type==3) {$("#worm_num").text("x"+res.data.tools_num)};
				$("#donated_mileage").text(res.data.avail_exchange_mileage/1000+"KM");
			}else{
				shanpao.pageelement.alert(res.result_err_msg);
			}
		});		
	}
	//兑换浇水、施肥、除虫本地
	function exchange(e){
		$("#jzlc").css("display","block");
		if (e=="watering_mile") {$(".b_img").attr("src","img/sh.png");$("#jzqd").attr("onclick","exchangeDonatedMileage('watering_mile')")}
		if (e=="fertilize_mile") {$(".b_img").attr("src","img/sf1.png");$("#jzqd").attr("onclick","exchangeDonatedMileage('fertilize_mile')")}
		if (e=="worm_mile") {$(".b_img").attr("src","img/cc1.png");$("#jzqd").attr("onclick","exchangeDonatedMileage('worm_mile')")}
	}
	//浇水、施肥、除虫操作
	function userProp(e){
		if (e=="js") {
			str='<img src="img/jiaoshui.png" alt="" class="jiaoshui"><img src="img/shuidi.png" alt="" class="jiaoshui1">';
			$(".ani").append(str);	
		}
		if (e=="sf") {
			str='<img src="img/fl.png" alt="" class="fl"><img src="img/fld.png" alt="" class="fld">';
			$(".ani").append(str);	
		}
		if (e=="cc") {
			str='<img src="img/ccj.png" alt="" class="ccj"><img src="img/cz.png" alt="" class="cz">';
			$(".ani").append(str);	
		}
		
		//app.alert('入口');
		var _data={};
		//设定接口名（修改）
        _data.cmd = 'welfareForest';
        _data.opt = 'userProp';     
        //构建接口参数（修改）
        _data.user_id = shanpao.dataformat.gethash().user_id;
        //_data.data.user_token = 'asdfasd'; //这个参数可以注释
        if (e=="js") {_data.type=1}
        if (e=="sf") {_data.type=2}
        if (e=="cc") {_data.type=3}
        //_data.item_id = 6;
        //_data.donated_value  = 6;     
        _data = JSON.stringify(_data);
        var _prm={};
        _prm.APIDATA = _data;
        console.log('主信息接口上传参数');
        console.log(_prm);
        console.log(_data);
        //发起请求
        shanpao.pageelement.loading();//打开loadi
        var url = shanpao.config.host + shanpao.config.welfare
		shanpao.interface.getData(url,_prm,function(res){						
			console.log(res);
			shanpao.pageelement.loading(0);//关闭loading			
			if(res.result==10000){			
				str='<div class="value">+5</div>';
			$(".ani").append(str);
			if (e=="js") {$("#watering_num").text("x"+res.data.tools_num);}
	        if (e=="sf") {$("#fertilize_num").text("x"+res.data.tools_num)}
	        if (e=="cc") {$("#worm_num").text("x"+res.data.tools_num)}
	        	$(".level").empty()
	        lv=res.data.level;
	        str='<p class="lvnum">'+res.data.level_desc+'</p>'
				+'<div class="progressbar"><p class="pb"></p><p class="pbnum">'+res.data.total_experience+'/'+res.data.level_expe_high+'</p></div>'
				$(".level").append(str)
				$(".pb").css("width",(res.data.total_experience/res.data.level_expe_high)*100+"%");
			}else{
				shanpao.pageelement.alert(res.result_err_msg);
			}
		});		
	}
	var question_id;
	//获取题目接口
	function getQuestion(){
		$("#answer").css("display","block")
		//app.alert('入口');
		var _data={};
		//设定接口名（修改）
        _data.cmd = 'welfareForest';
        _data.opt = 'getQuestion';     
        //构建接口参数（修改）
        _data.user_id = shanpao.dataformat.gethash().user_id;
        //_data.data.user_token = 'asdfasd'; //这个参数可以注释
        //_data.item_id = 6;
        //_data.donated_value  = 6;     
        _data = JSON.stringify(_data);
        var _prm={};
        _prm.APIDATA = _data;
        console.log('主信息接口上传参数');
        console.log(_prm);
        console.log(_data);
        //发起请求
        shanpao.pageelement.loading();//打开loadi
        var url = shanpao.config.host + shanpao.config.welfare
		shanpao.interface.getData(url,_prm,function(res){						
			console.log(res);
			shanpao.pageelement.loading(0);//关闭loading			
			if(res.result==10000){	
				question_id=res.data.question_id;		
				if (res.data.is_answer==true) {
					$(".q_t").text(res.data.answer_desc);
					$(".explain").remove();
					str='<div class="explain">'+res.data.answer_desc+'</div>';
					$("#answer").find($(".bbox")).append(str);

				}
				else{
					$(".t_t").remove();
					$(".km_btn").remove();
					$(".q_t").text(res.data.answer_desc)
					for (x in res.data.answer_option)
					{
					str='<div class="t_t"><img src="img/wsz.png" alt="" id="'+x+'" onclick="ck(this)"><p>'+res.data.answer_option[x]+'</p></div>';
					$("#answer").find($(".bbox")).append(str);
					}

					str='<div class="km_btn" onclick="answerQuestion()">提 交</div>';
					$("#answer").find($(".bbox")).append(str);
				}
			}else{
				shanpao.pageelement.alert(res.result_err_msg);
			}
		});		
	}
	//答题
	function answerQuestion(){
		//app.alert('入口');
		var _data={};
		//设定接口名（修改）
        _data.cmd = 'welfareForest';
        _data.opt = 'answerQuestion';     
        //构建接口参数（修改）
        _data.user_id = shanpao.dataformat.gethash().user_id;
        _data.question_id=question_id;
        _data.user_choose=da; 
        //_data.data.user_token = 'asdfasd'; //这个参数可以注释
        //_data.item_id = 6;
        //_data.donated_value  = 6;     
        _data = JSON.stringify(_data);
        var _prm={};
        _prm.APIDATA = _data;
        console.log('主信息接口上传参数');
        console.log(_prm);
        console.log(_data);
        //发起请求
        shanpao.pageelement.loading();//打开loadi
        var url = shanpao.config.host + shanpao.config.welfare
		shanpao.interface.getData(url,_prm,function(res){						
			console.log(res);
			shanpao.pageelement.loading(0);//关闭loading			
			if(res.result==10000){			
				if (res.data.is_true==true) {
					str='<div class="explain">'+res.data.answer+'</div>';
					$("#answer").find($(".bbox")).append(str)
				}
				else{
					str='<div class="explain">'+res.data.answer+'</div>';
					$("#answer").find($(".bbox")).append(str)
				}
			}
			else{
				shanpao.pageelement.alert(res.result_err_msg);
			}
		});		
	}
	var lbnum=0;
	//打开礼包
	function getFruit(){
		if (lbnum<=lbarr.length&&lbnum!=0) {

			//app.alert('入口');
			var _data={};
			//设定接口名（修改）
	        _data.cmd = 'welfareForest';
	        _data.opt = 'getFruit';     
	        //构建接口参数（修改）
	        _data.user_id = shanpao.dataformat.gethash().user_id;
	        //_data.data.user_token = 'asdfasd'; //这个参数可以注释
	        //_data.item_id = 6;
	        //_data.donated_value  = 6;    
			
				_data.package_id=lbarr[lbnum].package_id ;
				lbnum=lbnum+1;  
	        _data = JSON.stringify(_data);
	        var _prm={};
	        _prm.APIDATA = _data;
	        console.log('主信息接口上传参数');
	        console.log(_prm);
	        console.log(_data);
	        //发起请求
	        shanpao.pageelement.loading();//打开loadi
	        var url = shanpao.config.host + shanpao.config.welfare
			shanpao.interface.getData(url,_prm,function(res){						
				console.log(res);
				shanpao.pageelement.loading(0);//关闭loading			
				if(res.result==10000){	
					$("#lbbox").css("display","block")		
					if (res.data.fruit_num>0) {
						if (res.goods_info) {
							str='<div class="pg_box"><div class="package"><img src="'+res.data.thumb_pic+'" alt=""></div>'
								+'<p></p><span>'+res.data.valid_day+'</span></div>'
								+'<div class="pg_box"><div class="package"><img src="img/z2.png" alt=""></div><p>'+res.data.fruit_num+'个果实</p></div>'
								+'<div class="km_btn">确 定</div>'
								if (res.data.valid_day>0) {
									$(".pg_box").find("p").text(res.data.valid_day+"天装饰");
								}
								else{}
							$("#lbbox").find($(".bbox")).append(str);
						}
						else{
							str='<div class="pg_box1"><div class="package"><img src="img/z2.png" alt=""></div><p>'+res.data.fruit_num+'个果实</p></div>'
								+'<div class="km_btn">确 定</div>'
							$("#lbbox").find($(".bbox")).append(str);
						}
					}
					else{
						str='<div class="pg_box"><div class="package"><img src="'+res.data.thumb_pic+'" alt=""></div>'
							+'<p>'+res.data.title+'</p><span>'+res.data.title+'</span></div>'
							+'<div class="km_btn">确 定</div>'
							if (res.data.valid_day>0) {
									$(".pg_box").find("p").text(res.data.valid_day+"天装饰");
								}
								else{}
							$("#lbbox").find($(".bbox")).append(str);
					}
				}else{
					shanpao.pageelement.alert(res.result_err_msg);
				}
			});
		}
		else{};		
	}
	//数量加
	var jnum=0;
	function plus(){
		jnum=jnum+1;
		if (jnum<=5) {
			$(".shuidi").css("opacity","0")
			$("#sd"+jnum).css("opacity","1")	
			$(".km_jl").css("width",100-20*jnum+"%");
		}
		else{}
	}
	//数量减
	function reduce(){
		jnum=jnum-1;
		if (jnum>=0) {
			$(".shuidi").css("opacity","0")
			$("#sd"+jnum).css("opacity","1");
			$(".km_jl").css("width",20*(5-jnum)+"%");
		}
		else{}
		
	}
	$(function(){
		$(".close").click(function(){
			$(".bombbox").css("display","none")
		})
	})
</script>
</head>
<body>
	<!-- 夜晚星球 -->
	<div class="tree">
		<!-- 上半部分 -->
		<div class="tree_top">
			<!-- 背景 -->
			<img src="img/shu3.png" alt="" class="shubg">
			<!-- <img src="img/shu2.png" alt="" class="shubg"> -->
			<!-- <img src="img/shu3.png" alt="" class="shubg"> -->
			<!-- 等级 -->
			<div class="level"></div>
			<!-- 装饰品 -->
			<div class="ornament">
				<!-- <img src="img/z1.png" alt="z1" class="z1">
				<img src="img/z2.png" alt="z2" class="z2">
				<img src="img/z3.png" alt="z3" class="z3">
				<img src="img/z4.png" alt="z4" class="z4">
				<img src="img/z5.png" alt="z5" class="z5">
				<img src="img/z6.png" alt="z6" class="z6">
				<img src="img/z7.png" alt="z7" class="z7">
				<img src="img/z8.png" alt="z8" class="z8">
				<img src="img/z9.png" alt="z9" class="z9">
				<img src="img/z10.png" alt="z10" class="z10">
				<img src="img/z11.png" alt="z11" class="z11">
				<img src="img/z12.png" alt="z12" class="z12"> -->
			</div>
			<!-- 浇水动画 -->
			<div class="ani"></div>

			<!-- 礼包攻略等按钮 -->
			<img src="img/lb.png" alt="" class="ls_btn lb" onclick="getFruit()">
			<p class="dian"></p>
			<img src="img/gl.png" alt="" class="ls_btn gl">
			<img src="img/dt.png" alt="" class="ls_btn dt" onclick="getQuestion()">
			<img src="img/sd.png" alt="" class="ls_btn sd">
		</div>
		<!-- 下半部分 -->
		<div class="tree_bottom">
			<!-- 累计捐赠里程 -->
			<div class="tb_tip"><div>累计捐赠里程：</div><p id="donated_mileage"></p><span>(可进行道具兑换）</span></div>
			<!-- 捐赠 -->
			<div class="donation">
				<img src="img/js.png" alt="" id="js" onclick="userProp('js')">
				<p id="watering_num">X20</p>
				<div id="watering_mile" onclick="exchange('watering_mile')"></div>
			</div>
			<div class="donation">
				<img src="img/sf.png" alt="" id="sf" onclick="userProp('sf')">
				<p id="fertilize_num">X20</p>
				<div id="fertilize_mile" onclick="exchange('fertilize_mile')"></div>
			</div>
			<div class="donation">
				<img src="img/cc.png" alt="" id="cc" onclick="userProp('cc')">>
				<p id="worm_num">X20</p>
				<div id="worm_mile" onclick="exchange('worm_mile')"></div>
			</div>
		</div>
	</div>
	<!-- 捐赠里程 -->
	<div class="bombbox" style="display:none" id="jzlc">
		<div class="bbox">
			<p class="b_t">累计捐赠里程：<span id="donated_mileage1">126.00KM</span></p>
			<img src="img/sh.png" alt="" class="b_img">
			<div class="Km1">
				<div class="shuidi" id="sd5"><img src="img/shidi.png" alt=""><p>5</p></div>
				<div class="shuidi" id="sd4"><img src="img/shidi.png" alt=""><p>4</p></div>
				<div class="shuidi" id="sd3"><img src="img/shidi.png" alt=""><p>3</p></div>
				<div class="shuidi" id="sd2"><img src="img/shidi.png" alt=""><p>2</p></div>
				<div class="shuidi" id="sd1"><img src="img/shidi.png" alt=""><p>1</p></div>
				<div class="shuidi" id="sd0"><img src="img/shidi.png" alt=""><p>0</p></div>
			</div>
			<div class="km_box">
				<img src="img/iconjian.png" alt="" class="jian" onclick="reduce()">
				<div class="Km"><p class="km_jl"></p></div>
				<img src="img/iconjia.png" alt="" class="jia" onclick="plus()">
			</div>
			<div class="km_btn" onclick="exchangeDonatedMileage()" id="jzqd">确 定</div>
		</div>
	</div>
	<!-- 礼包 -->
	<div class="bombbox" style="display:none" id="lbbox">
		<div class="bbox">
			<img src="img/gxhd.png" alt="" class="gxhd">
			
		</div>
	</div>
	<!-- 答题 -->
	<div class="bombbox" style="display:none" id="answer">
		<div class="bbox">
			<img src="img/close.png" alt="" class="close">
			<p class="q_t">奥林匹克运动发源地是？</p>
			<div  class="tmtm"></div>
			<!-- 选项 -->
			<!-- <div class="t_t"><img src="img/wsz.png" alt=""><p>古希腊</p></div>
			<div class="t_t"><img src="img/wsz.png" alt=""><p>古希腊</p></div>
			<div class="t_t"><img src="img/wsz.png" alt=""><p>古希腊</p></div>
			<div class="t_t"><img src="img/wsz.png" alt=""><p>古希腊</p></div> -->

			<!-- 解释 -->
			<!-- <div class="explain">
				奥林匹克运动会起源于古希腊，因举办地点在奥林匹克而得名。传说古代奥运会是由众神之王宙斯所创始的。
			</div> -->
			<!-- 详情显示时隐藏 -->
			
		</div>
	</div>
</body>
</html>